<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahjong Tournament</title>

    <!-- CSS for both pages -->
    <link rel="stylesheet" href="index.css"/>

    <script>
        // Only load home.css if there's no hash
        if (!window.location.hash || window.location.hash.length <= 1) {
            const homeLink = document.createElement('link');
            homeLink.rel = 'stylesheet';
            homeLink.href = 'home.css';
            homeLink.id = 'home-css';
            document.head.appendChild(homeLink);
        }
    </script>

    <!-- Tournament page scripts (loaded conditionally) -->
    <script src="https://cdn.jsdelivr.net/npm/immutable@3.8.2/dist/immutable.min.js"></script>
    <script src="websocket-client.js" type="text/javascript"></script>

    <style>
        /* Page routing styles */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
    </style>
</head>
<body>

<!-- HOME PAGE -->
<div id="home-page" class="page">
    <h1>Julian's Mahjong Tournament Organizer</h1>

    <div class="home-containers">
        <div class="container">
            <h2>Create a New Tournament</h2>

            <div class="form-group">
                <label for="tournamentHash">Tournament ID</label>
                <input
                    type="text"
                    id="tournamentHash"
                    placeholder="HELLO"
                    maxlength="20"
                    autocomplete="off"
                />
                <div class="help-text">Choose a unique ID for your tournament</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="numPlayers">Number of Players</label>
                    <input type="number" id="numPlayers" value="12" min="3" max="100" />
                </div>
                <div class="form-group">
                    <label for="playersPerTable">Players per Table</label>
                    <input type="number" id="playersPerTable" value="4" min="3" max="4" />
                </div>
            </div>

            <div class="form-group">
                <label for="numRounds">Number of Rounds</label>
                <input type="number" id="numRounds" value="4" min="1" max="20" />
            </div>

            <button id="createBtn">Create Tournament</button>

            <div id="error" class="error"></div>
        </div>

        <div class="container">
            <h2>Go to Existing Tournament</h2>

            <div class="form-group">
                <label for="existingTournamentHash">Tournament ID</label>
                <input
                    type="text"
                    id="existingTournamentHash"
                    placeholder="HELLO"
                    maxlength="20"
                    autocomplete="off"
                />
                <div class="help-text">Enter the ID of an existing tournament</div>
            </div>

            <button id="goToBtn">Go to Tournament</button>

            <div id="goToError" class="error"></div>
        </div>
    </div>

    <script>
        const hashInput = document.getElementById('tournamentHash');
        const numPlayersInput = document.getElementById('numPlayers');
        const playersPerTableInput = document.getElementById('playersPerTable');
        const numRoundsInput = document.getElementById('numRounds');
        const createBtn = document.getElementById('createBtn');
        const errorDiv = document.getElementById('error');

        // Go to Tournament functionality
        const existingHashInput = document.getElementById('existingTournamentHash');
        const goToBtn = document.getElementById('goToBtn');
        const goToErrorDiv = document.getElementById('goToError');

        // Reset button states on page load (in case user hit back button)
        createBtn.disabled = false;
        createBtn.textContent = 'Create Tournament';
        goToBtn.disabled = false;
        goToBtn.textContent = 'Go to Tournament';

        // Auto-uppercase hash input
        hashInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });

        // Auto-uppercase existing tournament hash input
        existingHashInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });

        goToBtn.addEventListener('click', async () => {
            const hash = existingHashInput.value.trim();

            // Validation
            if (!hash) {
                showGoToError('Please enter a tournament ID');
                return;
            }

            if (hash.length < 2) {
                showGoToError('Tournament ID must be at least 2 characters');
                return;
            }

            // Check if tournament exists
            goToBtn.disabled = true;
            goToBtn.textContent = 'Checking...';

            try {
                const response = await fetch(`/api/tournament/${hash}`);

                if (response.ok) {
                    // Tournament exists, navigate to it
                    window.location = window.location.origin + window.location.pathname + '#' + hash;
                    window.location.reload();
                } else {
                    const data = await response.json();
                    showGoToError(data.error || 'Tournament not found');
                    goToBtn.disabled = false;
                    goToBtn.textContent = 'Go to Tournament';
                }
            } catch (err) {
                showGoToError('Network error - please try again');
                goToBtn.disabled = false;
                goToBtn.textContent = 'Go to Tournament';
            }
        });

        function showGoToError(message) {
            goToErrorDiv.textContent = message;
            goToErrorDiv.style.display = 'block';
            setTimeout(() => {
                goToErrorDiv.style.display = 'none';
            }, 5000);
        }

        createBtn.addEventListener('click', async () => {
            const hash = hashInput.value.trim();
            const numPlayers = parseInt(numPlayersInput.value);
            const playersPerTable = parseInt(playersPerTableInput.value);
            const numRounds = parseInt(numRoundsInput.value);

            // Validation
            if (!hash) {
                showError('Please enter a tournament ID');
                return;
            }

            if (hash.length < 2) {
                showError('Tournament ID must be at least 2 characters');
                return;
            }

            if (numPlayers < 3 || numPlayers > 100) {
                showError('Number of players must be between 3 and 100');
                return;
            }

            if (numPlayers % playersPerTable !== 0) {
                showError(`Number of players must be divisible by ${playersPerTable}`);
                return;
            }

            // Calculate number of groups
            const numGroups = numPlayers / playersPerTable;

            // Create tournament on server
            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';

            try {
                const response = await fetch('/api/tournament', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        hash,
                        config: {
                            groups: numGroups,
                            ofSize: playersPerTable,
                            forRounds: numRounds
                        }
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Redirect to tournament page via hash with forced reload
                    window.location = window.location.origin + window.location.pathname + '#' + hash;
                    window.location.reload();
                } else {
                    showError(data.error || 'Failed to create tournament');
                    createBtn.disabled = false;
                    createBtn.textContent = 'Create Tournament';
                }
            } catch (err) {
                showError('Network error - please try again');
                createBtn.disabled = false;
                createBtn.textContent = 'Create Tournament';
            }
        });

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Allow Enter key to create tournament
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !createBtn.disabled) {
                createBtn.click();
            }
        });

        // Reset buttons when page is shown (e.g., from back button)
        window.addEventListener('pageshow', (event) => {
            createBtn.disabled = false;
            createBtn.textContent = 'Create Tournament';
            goToBtn.disabled = false;
            goToBtn.textContent = 'Go to Tournament';
        });
    </script>
</div>

<!-- TOURNAMENT PAGE -->
<div id="tournament-page" class="page">
    <div id="controls">
        <h1>Julian's Mahjong Tournament Organizer</h1>
        <div>
	        <!-- Static text fields for Oka and Uma -->
<div class="oka-uma-row">
    <div>
        <label>Starting points:</label>
                </br>
        <input type="text" id="starting_points" value="25000">
    </div>

    <div>
        <label>Oka (per person):</label>
		</br>
        <input type="text" id="okaField" value="5000">
    </div>

    <div>
        <label>Uma:</label>
        <div class="uma-container">
            <input type="text" class="small-input" id="uma1" value="15">
            <input type="text" class="small-input" id="uma2" value="5">
            <input type="text" class="small-input" id="uma3" value="-5">
            <input type="text" class="small-input" id="uma4" value="-15">
        </div>
    </div>

    <div>
        <label>Chombo:</label>
        </br>
        <input type="text" id="chomboField" value="-10">
    </div>
</div>
		</br>
	    <div>
                <strong>Player Names</strong>
            </div>
            <div class="help-text">
                Player names can be provided for convenience.
                <br />If player names are omitted, players will be numbered.
                <br />Editing player names will update the current solution in
                real-time; you don't need to click "Recompute."
                <br />&nbsp;
                <br /><strong>Privacy:</strong> Names are never sent to our
                servers. All processing happens on your own computer.
                <br />&nbsp;
                <br />If two players have the same name, additional constraints
                (below) will apply to both of them.
                <br />&nbsp;
                <br />Tip: To produce mostly-even groups with an uneven number
                of players, create players named <tt>[Empty]</tt> to round out
                your roster, and add an <tt>[Empty],[Empty]</tt> constraint
                in the next box.
            </div>
            <div>
                <textarea id="playerNames" rows="13">
Allison
Brad
Charlie
Daniel
Edward
Fred
George
Harriet
Ivan
Jenny
Karen
Laura
</textarea>
            </div>
        </div>
        <div style="display: none;">
            <div>
                <strong>Never allow these pairs</strong>
            </div>
            <div class="help-text">
                Players grouped in this box are never grouped by the solver
                unless absolutely necessary.
                <br />Comma-separate names within a group.
                <br />Put groups on separate lines.
            </div>
            <div>
                <textarea id="forbiddenPairs" rows="6">
Brad, Danielle
[Empty], [Empty]
</textarea>
            </div>
        </div>
        <div style="display: none;">
            <div>
                <strong>Prefer splitting these groups</strong>
            </div>
            <div class="help-text">
                Similar to above, but lower priority.
                The solver avoids grouping players if they're already
                grouped here, but reducing repeat encounters can take
                priority in later rounds.
                <br />Tip: You can encourage the solver to gender-balance
                groups by listing all players of one gender in a group here.
            </div>
            <div>
                <textarea id="discouragedGroups" rows="6">
Brad,Ivan,Mona,Stan
</textarea>
            </div>
        </div>
        <div>
            <div class="help-text">
                The <strong>conflict score</strong> is a representation of how
                far the solution is from perfect - lower is better.
                <br />The <strong>Download CSV</strong> button provides a pivot
                view of the solution that makes it easier see the sequence of
                groups for a given player.
                <br />&nbsp;
                <br /><a href="javascript:hideHelp()">Close help.</a>
            </div>
        </div>
        <div>
	                <strong>Standings</strong> <span style="margin-left: 197px; font-weight: bold; color: #b22222;">Chombos</span>

	<!--<button id="calculateButton">Calculate</button>-->
	<div id="scoreBoard"></div> <!-- This will display the sorted finalScores -->
        </div>
        <p>
        </p>
        <p>
        </p>
    </div>
    <div id="results">

    </div>
</div>

<!-- Routing Script -->
<script>
    let tournamentScriptLoaded = false;
    let currentTournamentHash = null;

    function route() {
        const hash = window.location.hash.substring(1);
        const homeCss = document.getElementById('home-css');

        if (hash) {
            // Check if we're switching from one tournament to another
            if (currentTournamentHash && currentTournamentHash !== hash) {
                // Force reload when switching between different tournaments
                currentTournamentHash = hash;
                window.location.reload();
                return;
            }

            currentTournamentHash = hash;

            // Show tournament page
            document.getElementById('home-page').classList.remove('active');
            document.getElementById('tournament-page').classList.add('active');

            // Disable home.css
            if (homeCss) homeCss.disabled = true;

            // Load tournament.js if not already loaded
            if (!tournamentScriptLoaded) {
                const script = document.createElement('script');
                script.src = 'tournament.js';
                script.type = 'text/javascript';
                script.onload = function() {
                    // Call init() since DOMContentLoaded has already fired
                    if (typeof init === 'function') {
                        init();
                    }
                };
                document.head.appendChild(script);
                tournamentScriptLoaded = true;
            }
        } else {
            currentTournamentHash = null;
            // Show home page
            document.getElementById('home-page').classList.add('active');
            document.getElementById('tournament-page').classList.remove('active');

            // Enable home.css (or load it if not present)
            if (homeCss) {
                homeCss.disabled = false;
            } else {
                // Load home.css if it doesn't exist
                const homeLink = document.createElement('link');
                homeLink.rel = 'stylesheet';
                homeLink.href = 'home.css';
                homeLink.id = 'home-css';
                document.head.appendChild(homeLink);
            }

            // Reset button states when returning to home page
            const createBtn = document.getElementById('createBtn');
            const goToBtn = document.getElementById('goToBtn');
            if (createBtn) {
                createBtn.disabled = false;
                createBtn.textContent = 'Create Tournament';
            }
            if (goToBtn) {
                goToBtn.disabled = false;
                goToBtn.textContent = 'Go to Tournament';
            }
        }
    }

    // Route on load and hash change
    window.addEventListener('DOMContentLoaded', route);
    window.addEventListener('hashchange', route);
</script>


</body>
</html>
